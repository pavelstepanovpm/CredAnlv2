# Техническое задание на разработку плагина аналитики кредитного портфеля

## 1. Введение и назначение системы

### 1.1 Цель разработки
Создание плагина для казначейской системы, обеспечивающего аналитику кредитного портфеля с возможностью моделирования различных сценариев изменения параметров кредитования.

### 1.2 Основное назначение
- Консолидация данных по кредитному портфелю
- Расчет прогнозных графиков платежей
- Сценарное моделирование денежных потоков
- Визуализация ключевых метрик портфеля

---

## 2. Предметная область

### 2.1 Основные сущности

#### 2.1.1 Кредитный договор
**Атрибуты:**
- Уникальный идентификатор договора
- Тип кредита (кредитная линия, разовый кредит, овердрафт и т.д.)
- Валюта договора
- Общий лимит кредитования
- Доступный остаток лимита
- Дата начала действия договора
- Дата окончания / срок погашения
- График погашения (аннуитет, дифференцированный, единовременный и т.д.)
- Периодичность уплаты процентов
- Периодичность погашения основного долга

#### 2.1.2 Выборка (транш)
**Атрибуты:**
- Ссылка на кредитный договор
- Дата выборки
- Сумма выборки
- Тип процентной ставки (фиксированная/плавающая)
- Значение процентной ставки или формула расчета
- Базовая ставка для плавающей ставки (например, ключевая ставка ЦБ)
- Маржа к базовой ставке (для плавающих ставок)
- Статус (планируемая/фактическая)

#### 2.1.3 Погашение
**Атрибуты:**
- Ссылка на кредитный договор
- Дата погашения
- Сумма погашения основного долга
- Сумма погашения процентов
- Статус (планируемое/фактическое)

#### 2.1.4 Версия расчета
**Атрибуты:**
- Уникальный идентификатор версии
- Наименование версии
- Дата создания
- Автор версии
- Описание сценария
- Параметры сценария (например, значение ключевой ставки ЦБ)
- Признак базовой/альтернативной версии

### 2.2 Расчетные сущности

#### 2.2.1 График платежей (по отдельному кредиту)
**Структура:**
- Дата платежа
- Остаток долга на начало периода
- Сумма выборки (если есть)
- Сумма процентов к уплате
- Сумма погашения основного долга
- Общая сумма платежа


#### 2.2.2 Консолидированный кэш-флоу портфеля
**Структура:**
- Дата
- Общая сумма выборок
- Общая сумма погашений основного долга
- Общая сумма процентных платежей
- Чистый денежный поток (выборки минус погашения)

**Отображение данных в виде отчета на дату и период, задаваемые пользователем:** 
- Совокупный остаток долга на дату 
- Совокупный остаток доступного лимита на дату
- Остаток долга на начало периода
- Остаток долга на конец периода
- Остаток лимита на начало периода
- Остаток лимита на конец периода
---

## 3. Бизнес-логика системы

### 3.1 Получение данных из API

**Процесс:**
1. Подключение к API казначейской системы
2. Запрос списка активных кредитных договоров
3. Для каждого договора получение:
   - Основных параметров договора
   - Истории фактических выборок
   - Истории фактических погашений
4. Валидация полученных данных на полноту и корректность

**Правила валидации:**
- Обязательность ключевых полей (ID, даты, суммы, ставки)
- Логическая корректность дат (дата начала < дата окончания)
- Непревышение выборок над лимитом
- Корректность ставок (положительные значения)

### 3.2 Расчет графика платежей по кредиту

#### 3.2.1 Входные данные
- Параметры кредитного договора
- Фактические выборки и погашения
- Текущее значение базовой ставки (для плавающих ставок)

#### 3.2.2 Логика расчета процентной ставки

**Для фиксированной ставки:**
- Использовать указанную в договоре ставку на весь период

**Для плавающей ставки:**
- Текущая ставка = Базовая ставка (например, ключевая ставка ЦБ) + Маржа
- При изменении базовой ставки в сценарии - пересчитать ставку по кредиту
- Применять новую ставку к непогашенному остатку

#### 3.2.3 Алгоритм построения графика

**Шаг 1: Формирование временной сетки**
- Определить все значимые даты: выборки, погашения, начисления процентов
- Упорядочить даты по возрастанию
- Добавить граничные даты периода расчета

**Шаг 2: Расчет по каждой дате**

Для каждой даты в хронологическом порядке:

1. **Фиксация остатка долга на начало дня**
   - Взять остаток с конца предыдущего дня

2. **Обработка выборок**
   - Если на эту дату есть выборка: увеличить остаток долга
   - Уменьшить доступный лимит

3. **Расчет процентов**
   - Если дата является датой платежа по процентам:
   - Рассчитать проценты за период: Остаток долга × Ставка × Количество дней / База (360 или 365)
   - Зафиксировать сумму процентов к уплате

4. **Обработка погашений**
   - Если на эту дату есть погашение основного долга:
   - Уменьшить остаток долга на сумму погашения
   - Увеличить доступный лимит (для возобновляемых кредитов)

5. **Фиксация остатка долга на конец дня**
   - Остаток = Остаток на начало + Выборки - Погашения

**Шаг 3: Учет типа графика погашения**

**Аннуитетный:**
- Рассчитать фиксированный платеж по формуле аннуитета
- Распределить платеж между процентами и телом долга

**Дифференцированный:**
- Тело долга погашается равными долями
- Проценты начисляются на остаток

**Единовременный:**
- Все тело долга погашается в конце срока
- Проценты по графику (ежемесячно, ежеквартально и т.д.)

**Индивидуальный:**
- Использовать даты и суммы из плановых погашений

### 3.3 Консолидация портфеля

**Алгоритм:**
1. Получить графики платежей по всем кредитам версии
2. Объединить все даты из всех графиков
3. Для каждой уникальной даты:
   - Просуммировать выборки по всем кредитам
   - Просуммировать погашения по всем кредитам
   - Просуммировать процентные платежи

4. Сформировать консолидированный кэш-флоу

### 3.4 Управление версиями расчетов

#### 3.4.1 Создание базовой версии
**Процесс:**
1. Пользователь инициирует создание новой версии
2. Указывает название и описание
3. Система использует текущие значения параметров (текущая ключевая ставка ЦБ и т.д.)
4. Выполняется расчет графиков по всем кредитам
5. Формируется консолидированный кэш-флоу
6. Версия сохраняется с признаком "базовая"

#### 3.4.2 Создание сценарной версии
**Процесс:**
1. Пользователь выбирает базовую версию для копирования
2. Указывает название и описание сценария
3. Изменяет параметры сценария:
   - Значение ключевой ставки ЦБ
   - Даты выборок (добавление/удаление плановых выборок)
   - Даты досрочных погашений
   - Другие параметры моделирования

4. Система пересчитывает:
   - Плавающие ставки по кредитам (если изменилась базовая ставка)
   - Графики платежей по затронутым кредитам
   - Консолидированный кэш-флоу

5. Версия сохраняется с признаком "сценарная" и ссылкой на базовую

#### 3.4.3 Правила работы с версиями
- Одна версия может быть помечена как "активная"
- Версии неизменяемы после создания
- Для изменений создается новая версия
- Возможность сравнения версий между собой на одном графике или таблице
- Хранение истории всех версий

## 4. Интерфейс и архитектура
1. Интерфейс должен быть профессиональным, чистым и ясным, современным в стиле трейдиноговых терминалов
2. В качестве библиотеки финансовых расчетов использовать Quantlib

